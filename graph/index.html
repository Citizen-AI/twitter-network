<!DOCTYPE html>
<meta charset="utf-8">
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="https://d3js.org/d3.v5.min.js"></script>
  </head>
  <body></body>
  <script>

// TODO: arrows coloured
// TODO: centred labels
// TODO: button for turning links on and off
// TODO: https://bl.ocks.org/BTKY/6c282b65246f8f46bb55aadc322db709
// TODO: download images before rendering anything
// TODO: search

width = window.innerWidth;
height = window.innerHeight;

d3.select('body')
  .append("svg")
  .attr("width", width)
  .attr("height", height);

var svg = d3.select("svg");

size_scale = d3
  .scalePow()
    .exponent(0.5)
    .domain([0, 100])
    .range([1,30])


party_colour = type => {
  switch(type) {
    case 'National': return 'blue';
    case 'Labour': return 'red';
    case 'NZ First': return 'black';
    case 'Green': return 'green';
    case 'Act': return 'yellow';
    default: return '#888';
  }
}

link_source_node = (nodes, node) => nodes.find(n => n.id === node.source)
node_links = (links, node) => links.filter(l => l.source===node.id)

node_size = d => size_scale(d.val);
image_size = d => size_scale(d.val) * 2;
node_colour = d => party_colour(d.party)
node_label = d => d.name;
node_title = d => d.name + ': ' + d.description;
node_fill = d => d.image ? 'url(' + d.image + ')' : 'white';
link_text = d => d.last_text;

d3
  .json('mps.json')
  .then(graph => {
    link_colour = d => party_colour(link_source_node(graph.nodes, d).party);

    var g = svg.append("g")
      .attr("class", "everything");

    var defs = g.append('defs')

    var imgPattern = defs.selectAll("pattern")
      .data(graph.nodes)
    	.enter()
        .append("pattern")
          .attr("id", d => d.id)
          .attr("width", 1)
          .attr("height", 1)
          .attr("patternUnits", "objectBoundingBox")
      	.append("image")
      		.attr("x", 0)
      		.attr("y", 0)
      		.attr("width", image_size)
          .attr("height", image_size)
          .attr("xlink:href", d => d.image)

    var arrows = defs.selectAll("marker") // https://jsfiddle.net/4xt5v51m/3/
            .data(["end"])
          .enter().append("svg:marker")
            .attr("id", String)
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 0)
            .attr("refY", 0.5)
            .attr("markerWidth", 2)
            .attr("markerHeight", 2)
            .attr("orient", "auto")
            .attr("fill", 'white')
          .append("svg:path")
            .attr("d", "M0,-5L10,0L0,5");

    var link = g.append("g")
      .attr("class", "links")
      .selectAll("line")
      .data(graph.links)
      .enter()
        .append("line")
          .style("stroke", link_colour)
          .attr("marker-end", "url(#end)")

    link
      .append("title")
      .text(link_text);

    var elem = g.append('g')
        .attr('class', 'nodes')
      .selectAll('circle')
        .data(graph.nodes)
      .enter()
        .append('g')

    var circle = elem
      .append('circle')
        .attr("r", node_size)
        .style("fill", 'white')
        .style('stroke', node_colour)
        .style('fill', d => 'url(#' + d.id + ')')
        .on('mouseover', d => {   // https://stackoverflow.com/questions/19111581/d3js-force-directed-on-hover-to-node-highlight-colourup-linked-nodes-and-link
          link.style('stroke-opacity', l =>
            (d.id === l.source.id || d.id === l.target.id) ? 1 : 0.05)
          }
        )
        .on('mouseout', d => link.style('stroke-opacity', 0.05))
      .append("title").text(node_title);




    var drag_handler = d3.drag()
      .on("start", d => {
          if (!d3.event.active) simulation.alphaTarget(0.3).restart();
          d.fx = d.x;
          d.fy = d.y; })
      .on("drag", d => {
          d.fx = d3.event.x;
          d.fy = d3.event.y; })
      .on("end", d => {
          if (!d3.event.active) simulation.alphaTarget(0);
          d.fx = null;
          d.fy = null;});

    drag_handler(elem);

    tick = () => {
      elem.attr('transform', d => 'translate(' + d.x + ',' + d.y + ')')

      var arrowLength = 2;  // https://stackoverflow.com/a/24313834/1876628
      link.each(d => {
        var nodeRadius = size_scale(d.target.val);
        var x1 = d.source.x,
            y1 = d.source.y,
            x2 = d.target.x,
            y2 = d.target.y,
            angle = Math.atan2(y2 - y1, x2 - x1);
        d.targetX = x2 - Math.cos(angle) * (nodeRadius + arrowLength);
        d.targetY = y2 - Math.sin(angle) * (nodeRadius + arrowLength);
      });

      link
        .attr("x1", d => d.source.x)
        .attr("y1", d => d.source.y)
        .attr("x2", d => d.targetX)
        .attr("y2", d => d.targetY);
    }

    var simulation = d3.forceSimulation()
    	.nodes(graph.nodes)
      .force('charge_force', d3.forceManyBody().strength(-60))
      .force('center_force', d3.forceCenter(width / 2, height / 2))
      .force('collision', d3.forceCollide().radius(node_size))
      .force('links', d3.forceLink(graph.links).id(d => d.id))
      .on('tick', tick);

    var zoom_handler = d3
      .zoom()
      .on("zoom", () => g.attr("transform", d3.event.transform));

    zoom_handler(g);
  });

  </script>
</html>
